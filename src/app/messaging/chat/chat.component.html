<div class="chat-container">
  <!-- Sidebar - Conversations List -->
  <div class="chat-sidebar" [class.mobile-hidden]="isMobileView && !showSidebarOnMobile">
    <div class="sidebar-header">
      <h2>Messages</h2>
      <span class="unread-badge" *ngIf="totalUnreadCount > 0" [matBadge]="totalUnreadCount" matBadgeColor="warn"></span>
    </div>

    <!-- Loading State -->
    <div *ngIf="loadingConversations" class="loading-state">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading conversations...</p>
    </div>

    <!-- Conversations List -->
    <div *ngIf="!loadingConversations" class="conversations-list">
      <div
        *ngFor="let conversation of conversations"
        class="conversation-item"
        [class.active]="selectedConversation?.id === conversation.id"
        [class.unread]="conversation.unreadCount > 0"
        (click)="selectConversation(conversation)"
      >
        <div class="conversation-avatar">
          <img [src]="conversation.participantAvatars?.[0] || 'https://i.pravatar.cc/150?img=1'" alt="Avatar">
          <span class="unread-indicator" *ngIf="conversation.unreadCount > 0"></span>
        </div>

        <div class="conversation-info">
          <div class="conversation-header">
            <h3 class="conversation-name">{{ conversation.participantNames[0] }}</h3>
            <span class="conversation-time" *ngIf="conversation.lastMessage">
              {{ formatTime(conversation.lastMessage.timestamp) }}
            </span>
          </div>

          <div class="conversation-preview">
            <p class="last-message" *ngIf="conversation.lastMessage">
              {{ conversation.lastMessage.content }}
            </p>
            <p class="job-title" *ngIf="conversation.jobTitle">
              <mat-icon>work</mat-icon>
              {{ conversation.jobTitle }}
            </p>
          </div>

          <span class="unread-count" *ngIf="conversation.unreadCount > 0">
            {{ conversation.unreadCount }}
          </span>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="conversations.length === 0" class="empty-conversations">
        <mat-icon>chat_bubble_outline</mat-icon>
        <h3>No Conversations Yet</h3>
        <p>Start a conversation with a freelancer or customer</p>
      </div>
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="chat-main" [class.mobile-hidden]="isMobileView && showSidebarOnMobile">
    <!-- No Conversation Selected -->
    <div *ngIf="!selectedConversation" class="no-conversation-selected">
      <mat-icon>forum</mat-icon>
      <h2>Select a Conversation</h2>
      <p>Choose a conversation from the list to start messaging</p>
    </div>

    <!-- Chat Header -->
    <div *ngIf="selectedConversation" class="chat-header">
      <!-- Mobile back button -->
      <button mat-icon-button class="mobile-back-btn" (click)="backToConversations()" *ngIf="isMobileView">
        <mat-icon>arrow_back</mat-icon>
      </button>

      <div class="chat-header-info">
        <img [src]="getOtherParticipantAvatar()" alt="Avatar" class="header-avatar">
        <div class="header-details">
          <h3>{{ getOtherParticipantName() }}</h3>
          <p class="job-context" *ngIf="selectedConversation.jobTitle">
            <mat-icon>work</mat-icon>
            {{ selectedConversation.jobTitle }}
          </p>
        </div>
      </div>

      <div class="chat-header-actions">
        <button mat-icon-button matTooltip="Video Call" disabled>
          <mat-icon>videocam</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Call" disabled>
          <mat-icon>call</mat-icon>
        </button>
        <button mat-icon-button matTooltip="More Options" disabled>
          <mat-icon>more_vert</mat-icon>
        </button>
      </div>
    </div>

    <!-- Messages Area -->
    <div *ngIf="selectedConversation" class="messages-container" #messagesContainer>
      <!-- Loading Messages -->
      <div *ngIf="loading" class="messages-loading">
        <mat-spinner diameter="40"></mat-spinner>
      </div>

      <!-- Messages List -->
      <div *ngIf="!loading" class="messages-list">
        <div
          *ngFor="let message of messages"
          class="message-wrapper"
          [class.own-message]="isMyMessage(message)"
          [class.other-message]="!isMyMessage(message)"
        >
          <div class="message-avatar" *ngIf="!isMyMessage(message)">
            <img [src]="message.senderAvatar || 'https://i.pravatar.cc/150?img=1'" alt="Avatar">
          </div>

          <div class="message-bubble">
            <div class="message-content">{{ message.content }}</div>
            <div class="message-meta">
              <span class="message-time">{{ formatMessageTime(message.timestamp) }}</span>
              <mat-icon *ngIf="isMyMessage(message)" class="read-indicator" [class.read]="message.read">
                {{ message.read ? 'done_all' : 'done' }}
              </mat-icon>
            </div>
          </div>

          <div class="message-avatar" *ngIf="isMyMessage(message)">
            <img [src]="message.senderAvatar || 'https://i.pravatar.cc/150?img=2'" alt="Avatar">
          </div>
        </div>

        <!-- Typing Indicator -->
        <div *ngIf="typingUsers.size > 0" class="typing-indicator">
          <div class="typing-avatar">
            <img [src]="getOtherParticipantAvatar()" alt="Avatar">
          </div>
          <div class="typing-bubble">
            <span class="typing-text">{{ getTypingText() }}</span>
            <div class="typing-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Input -->
    <div *ngIf="selectedConversation" class="message-input-container">
      <mat-form-field appearance="outline" class="message-input-field">
        <mat-icon matPrefix>edit</mat-icon>
        <input
          matInput
          [(ngModel)]="messageText"
          (input)="onMessageInput()"
          (keydown.enter)="sendMessage()"
          placeholder="Type a message..."
          [disabled]="sendingMessage"
          #messageInput
        >
        <button
          mat-icon-button
          matSuffix
          matTooltip="Attach File"
          [disabled]="sendingMessage"
        >
          <mat-icon>attach_file</mat-icon>
        </button>
        <button
          mat-icon-button
          matSuffix
          matTooltip="Add Emoji"
          [disabled]="sendingMessage"
        >
          <mat-icon>emoji_emotions</mat-icon>
        </button>
      </mat-form-field>

      <button
        mat-fab
        color="primary"
        (click)="sendMessage()"
        [disabled]="!messageText.trim() || sendingMessage"
        class="send-button"
      >
        <mat-spinner *ngIf="sendingMessage" diameter="24"></mat-spinner>
        <mat-icon *ngIf="!sendingMessage">send</mat-icon>
      </button>
    </div>
  </div>
</div>
